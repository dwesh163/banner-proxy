pid {{ .PID }};
error_log stderr;
events {}
daemon off;

env BANNER_MESSAGE;
env BANNER_COLOR;

http {
    include /etc/nginx/mime.types;
    client_max_body_size 50M;
    
    client_body_temp_path /tmp/nginx/client_body_temp;
    proxy_temp_path /tmp/nginx/proxy_temp;
    fastcgi_temp_path /tmp/nginx/fastcgi_temp;
    uwsgi_temp_path /tmp/nginx/uwsgi_temp;
    scgi_temp_path /tmp/nginx/scgi_temp;
    
    upstream upstream-default-backend {
        server 127.0.0.1:8080;
    }

    server {
        listen 127.0.0.1:{{ .StatusPort }};
        location /healthz {
            return 200;
        }
        location /nginx_status {
            stub_status on;
        }
        location / {
            return 404;
        }
    }

    {{ range $server := .Servers }}
    server {
        server_name {{ $server.Hostname }} {{ range $server.Aliases }}{{ . }} {{ end }};
        
        set_by_lua_block $banner_message { return os.getenv("BANNER_MESSAGE") or "Welcome! This is a banner." }
        set_by_lua_block $banner_color { return os.getenv("BANNER_COLOR") or "#d97706" }
        
        location / {
            {{ if $server.Locations }}
            {{ range $location := $server.Locations }}
            {{ if $location.Backend }}
            proxy_pass http://{{ $location.Backend }};
            {{ end }}
            {{ end }}
            {{ end }}
            
            sub_filter '</head>' '<script>window.BANNER_MESSAGE="$banner_message";window.BANNER_COLOR="$banner_color";</script><script src="/banner.js"></script></head>';
            sub_filter_once on;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /banner.js {
            root /etc/nginx/static;
            add_header Content-Type "application/javascript";
        }
    }
    {{ end }}
}
